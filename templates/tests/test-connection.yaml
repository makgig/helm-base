apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "base.fullname" . }}-test"
  labels:
    {{- include "base.labels" . | nindent 4 }}
  annotations:
    # Указываем, что это тестовый под
    "helm.sh/hook": test
    # Удаляем тестовый под перед новым тестом и после успешного выполнения
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
spec:
  containers:
    - name: test
      # Используем простой Alpine образ с curl для тестирования
      image: curlimages/curl:8.4.0
      command:
        - /bin/sh
        - -ec
        - |
          # Проверяем каждый сервис, который включен в деплойменте
          {{- range .Values.deployments }}
          {{- if and .service .service.enabled }}
          echo "Testing service {{ include "base.fullname" $ }}-{{ .name }}"
          
          # Делаем простой HTTP запрос к сервису
          curl --retry 3 --retry-delay 5 --retry-all-errors \
               --fail \
               http://{{ include "base.fullname" $ }}-{{ .name }}:{{ .service.port | default 80 }}/ \
               || exit 1
          
          echo "Service {{ include "base.fullname" $ }}-{{ .name }} is responding"
          {{- end }}
          {{- end }}
  restartPolicy: Never


